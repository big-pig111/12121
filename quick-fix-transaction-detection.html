<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿä¿®å¤äº¤æ˜“æ£€æµ‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .status-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .status-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .status-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .action-btn:hover {
            background: #0056b3;
        }
        .action-btn.success {
            background: #28a745;
        }
        .action-btn.success:hover {
            background: #218838;
        }
        .action-btn.danger {
            background: #dc3545;
        }
        .action-btn.danger:hover {
            background: #c82333;
        }
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¿«é€Ÿä¿®å¤äº¤æ˜“æ£€æµ‹</h1>
        <p>ä¸€é”®ä¿®å¤äº¤æ˜“æ£€æµ‹åŠŸèƒ½ï¼ŒæŒ‰æ­£ç¡®é¡ºåºåŠ è½½æ‰€æœ‰æ¨¡å—</p>

        <!-- ä¿®å¤è¿›åº¦ -->
        <div class="section">
            <h2>ğŸ“Š ä¿®å¤è¿›åº¦</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">å‡†å¤‡å¼€å§‹ä¿®å¤...</div>
        </div>

        <!-- ä¿®å¤çŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ”§ ä¿®å¤çŠ¶æ€</h2>
            <div id="fixStatus">
                ç­‰å¾…å¼€å§‹ä¿®å¤...
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="section">
            <h2>ğŸ¯ æ“ä½œ</h2>
            <button class="action-btn success" onclick="startQuickFix()">ğŸš€ å¼€å§‹å¿«é€Ÿä¿®å¤</button>
            <button class="action-btn" onclick="checkStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
            <button class="action-btn danger" onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰</button>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ ä¿®å¤æ—¥å¿—</h2>
            <div id="fixLogContainer" class="log-container">
                ç­‰å¾…ä¿®å¤æ—¥å¿—...
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„ä¾èµ– -->
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        let fixLog = [];
        let currentStep = 0;
        const totalSteps = 12;

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            fixLog.push(logEntry);
            
            const logContainer = document.getElementById('fixLogContainer');
            logContainer.textContent = fixLog.join('\n');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(step, message) {
            currentStep = step;
            const progress = (step / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${step}/${totalSteps}: ${message}`;
        }

        // å¼€å§‹å¿«é€Ÿä¿®å¤
        async function startQuickFix() {
            addLog('å¼€å§‹å¿«é€Ÿä¿®å¤äº¤æ˜“æ£€æµ‹åŠŸèƒ½...', 'info');
            
            try {
                // æ­¥éª¤1: æ£€æŸ¥ä¾èµ–
                updateProgress(1, 'æ£€æŸ¥ä¾èµ–...');
                await checkDependencies();
                
                // æ­¥éª¤2: æ¸…é™¤ç°æœ‰æ¨¡å—
                updateProgress(2, 'æ¸…é™¤ç°æœ‰æ¨¡å—...');
                clearExistingModules();
                
                // æ­¥éª¤3-10: æŒ‰é¡ºåºåŠ è½½æ¨¡å—
                const modules = [
                    { name: 'Utils', path: 'js/modules/Utils.js' },
                    { name: 'BackendManager', path: 'js/modules/BackendManager.js' },
                    { name: 'CountdownManager', path: 'js/modules/CountdownManager.js' },
                    { name: 'TransactionTracker', path: 'js/modules/TransactionTracker.js' },
                    { name: 'UIEffects', path: 'js/modules/UIEffects.js' },
                    { name: 'TokenHoldersManager', path: 'js/modules/TokenHoldersManager.js' },
                    { name: 'WalletManager', path: 'js/modules/WalletManager.js' },
                    { name: 'WhitepaperModal', path: 'js/modules/WhitepaperModal.js' },
                    { name: 'ClaimRewardModal', path: 'js/modules/ClaimRewardModal.js' }
                ];
                
                for (let i = 0; i < modules.length; i++) {
                    const module = modules[i];
                    updateProgress(3 + i, `åŠ è½½æ¨¡å—: ${module.name}...`);
                    await loadModule(module.name, module.path);
                }
                
                // æ­¥éª¤11: åŠ è½½ä¸»åº”ç”¨
                updateProgress(11, 'åŠ è½½ä¸»åº”ç”¨...');
                await loadModule('MemeCoinApp', 'js/app.js');
                
                // æ­¥éª¤12: åˆå§‹åŒ–åº”ç”¨
                updateProgress(12, 'åˆå§‹åŒ–åº”ç”¨...');
                await initializeApplication();
                
                addLog('å¿«é€Ÿä¿®å¤å®Œæˆï¼', 'success');
                checkStatus();
                
            } catch (error) {
                addLog(`ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                updateProgress(currentStep, `é”™è¯¯: ${error.message}`);
            }
        }

        // æ£€æŸ¥ä¾èµ–
        async function checkDependencies() {
            addLog('æ£€æŸ¥ä¾èµ–...', 'info');
            
            // æ£€æŸ¥ Solana Web3
            if (typeof solana === 'undefined') {
                addLog('Solana Web3 æœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½...', 'warning');
                await loadScript('https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js');
            } else {
                addLog('Solana Web3 å·²åŠ è½½', 'success');
            }
            
            // æ£€æŸ¥ Firebase
            if (typeof firebase === 'undefined') {
                addLog('Firebase æœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½...', 'warning');
                await loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js');
                await loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js');
            } else {
                addLog('Firebase å·²åŠ è½½', 'success');
            }
        }

        // æ¸…é™¤ç°æœ‰æ¨¡å—
        function clearExistingModules() {
            addLog('æ¸…é™¤ç°æœ‰æ¨¡å—...', 'info');
            
            const modules = [
                'Utils', 'BackendManager', 'CountdownManager', 'TransactionTracker',
                'UIEffects', 'TokenHoldersManager', 'WalletManager', 'WhitepaperModal',
                'ClaimRewardModal', 'MemeCoinApp'
            ];
            
            modules.forEach(moduleName => {
                if (window[moduleName]) {
                    delete window[moduleName];
                    addLog(`æ¸…é™¤æ¨¡å—: ${moduleName}`, 'info');
                }
            });
            
            // æ¸…é™¤å…¨å±€å®ä¾‹
            delete window.backendManager;
            delete window.transactionTracker;
            delete window.memeCoinApp;
            
            addLog('æ¨¡å—æ¸…é™¤å®Œæˆ', 'success');
        }

        // åŠ è½½æ¨¡å—
        async function loadModule(moduleName, scriptPath) {
            addLog(`åŠ è½½æ¨¡å—: ${moduleName} (${scriptPath})`, 'info');
            
            try {
                await loadScript(scriptPath);
                
                // éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof window[moduleName] !== 'undefined') {
                    addLog(`æ¨¡å— ${moduleName} åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    throw new Error(`æ¨¡å— ${moduleName} åŠ è½½åæœªå®šä¹‰`);
                }
                
            } catch (error) {
                addLog(`æ¨¡å— ${moduleName} åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApplication() {
            addLog('åˆå§‹åŒ–åº”ç”¨...', 'info');
            
            if (typeof MemeCoinApp === 'undefined') {
                throw new Error('MemeCoinApp ç±»æœªå®šä¹‰');
            }
            
            try {
                // åˆ›å»ºåº”ç”¨å®ä¾‹
                window.memeCoinApp = new MemeCoinApp();
                addLog('åº”ç”¨å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                let attempts = 0;
                const maxAttempts = 50; // æœ€å¤šç­‰å¾…5ç§’
                
                while (!window.memeCoinApp.isInitialized && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.memeCoinApp.isInitialized) {
                    addLog('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');
                } else {
                    addLog('åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ï¼Œä½†å¯èƒ½ä»åœ¨è¿›è¡Œä¸­', 'warning');
                }
                
                // æ£€æŸ¥äº¤æ˜“æ£€æµ‹çŠ¶æ€
                const detectionConfig = localStorage.getItem('memeCoinDetection');
                if (detectionConfig) {
                    const config = JSON.parse(detectionConfig);
                    if (config.isRunning) {
                        addLog('æ£€æµ‹é…ç½®å·²å¯ç”¨ï¼Œæ­£åœ¨å¯åŠ¨äº¤æ˜“æ£€æµ‹...', 'info');
                        
                        // æ‰‹åŠ¨å¯åŠ¨äº¤æ˜“æ£€æµ‹
                        if (window.memeCoinApp.modules.transaction) {
                            try {
                                await window.memeCoinApp.modules.transaction.connect(config.rpcUrl);
                                await window.memeCoinApp.modules.transaction.startTracking(config.tokenAddress);
                                addLog('äº¤æ˜“æ£€æµ‹å¯åŠ¨æˆåŠŸï¼', 'success');
                            } catch (error) {
                                addLog(`äº¤æ˜“æ£€æµ‹å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                            }
                        } else {
                            addLog('TransactionTracker æ¨¡å—ä¸å¯ç”¨', 'error');
                        }
                    } else {
                        addLog('æ£€æµ‹é…ç½®æœªå¯ç”¨', 'info');
                    }
                } else {
                    addLog('æœªæ‰¾åˆ°æ£€æµ‹é…ç½®', 'info');
                }
                
            } catch (error) {
                addLog(`åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ£€æŸ¥çŠ¶æ€
        function checkStatus() {
            addLog('æ£€æŸ¥å½“å‰çŠ¶æ€...', 'info');
            
            const statusDiv = document.getElementById('fixStatus');
            let statusHtml = '';
            
            // æ£€æŸ¥æ¨¡å—åŠ è½½çŠ¶æ€
            const modules = [
                'Utils', 'BackendManager', 'CountdownManager', 'TransactionTracker',
                'UIEffects', 'TokenHoldersManager', 'WalletManager', 'WhitepaperModal',
                'ClaimRewardModal', 'MemeCoinApp'
            ];
            
            let loadedCount = 0;
            modules.forEach(moduleName => {
                const isLoaded = typeof window[moduleName] !== 'undefined';
                if (isLoaded) loadedCount++;
                
                const status = isLoaded ? 'success' : 'error';
                const label = isLoaded ? 'âœ…' : 'âŒ';
                
                statusHtml += `
                    <div class="status-item ${status}">
                        <div class="status-label">${label} ${moduleName}</div>
                        <div class="status-value">çŠ¶æ€: ${isLoaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}</div>
                    </div>
                `;
            });
            
            // æ£€æŸ¥åº”ç”¨çŠ¶æ€
            if (window.memeCoinApp) {
                const isInitialized = window.memeCoinApp.isInitialized;
                const status = isInitialized ? 'success' : 'warning';
                const label = isInitialized ? 'âœ…' : 'âš ï¸';
                
                statusHtml += `
                    <div class="status-item ${status}">
                        <div class="status-label">${label} MemeCoinApp å®ä¾‹</div>
                        <div class="status-value">åˆå§‹åŒ–çŠ¶æ€: ${isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</div>
                        <div class="status-value">æ¨¡å—æ•°é‡: ${Object.keys(window.memeCoinApp.modules || {}).length}</div>
                    </div>
                `;
            }
            
            // æ£€æŸ¥äº¤æ˜“æ£€æµ‹çŠ¶æ€
            const detectionConfig = localStorage.getItem('memeCoinDetection');
            if (detectionConfig) {
                const config = JSON.parse(detectionConfig);
                const status = config.isRunning ? 'success' : 'warning';
                const label = config.isRunning ? 'âœ…' : 'âš ï¸';
                
                statusHtml += `
                    <div class="status-item ${status}">
                        <div class="status-label">${label} äº¤æ˜“æ£€æµ‹é…ç½®</div>
                        <div class="status-value">è¿è¡ŒçŠ¶æ€: ${config.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</div>
                        <div class="status-value">RPC URL: ${config.rpcUrl || 'æœªè®¾ç½®'}</div>
                        <div class="status-value">Token Address: ${config.tokenAddress || 'æœªè®¾ç½®'}</div>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = statusHtml;
            addLog(`çŠ¶æ€æ£€æŸ¥å®Œæˆ: ${loadedCount}/${modules.length} ä¸ªæ¨¡å—å·²åŠ è½½`, 'info');
        }

        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¨¡å—å’Œåº”ç”¨å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰åŠ è½½çš„æ¨¡å—ã€‚')) {
                addLog('é‡ç½®æ‰€æœ‰æ¨¡å—...', 'warning');
                
                // æ¸…é™¤æ‰€æœ‰æ¨¡å—
                clearExistingModules();
                
                // é‡ç½®è¿›åº¦
                updateProgress(0, 'å·²é‡ç½®');
                
                // æ¸…é™¤æ—¥å¿—
                fixLog = [];
                document.getElementById('fixLogContainer').textContent = 'æ—¥å¿—å·²æ¸…ç©º...';
                
                addLog('é‡ç½®å®Œæˆ', 'info');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            addLog('å¿«é€Ÿä¿®å¤å·¥å…·å·²å¯åŠ¨', 'info');
            updateProgress(0, 'å‡†å¤‡å°±ç»ª');
        });
    </script>
</body>
</html> 