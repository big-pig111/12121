<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Reward Claim - MEME TO THE MOON</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        .info { background: #2196F3; }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .code {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Debug Reward Claim</h1>
    
    <div class="debug-section">
        <h2>1. é’±åŒ…è¿æ¥çŠ¶æ€</h2>
        <div id="walletStatus" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
        <button onclick="checkWalletStatus()">åˆ·æ–°é’±åŒ…çŠ¶æ€</button>
    </div>

    <div class="debug-section">
        <h2>2. åå°å¥–åŠ±åœ°å€é…ç½®</h2>
        <div id="backendConfig" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkBackendConfig()">åˆ·æ–°åå°é…ç½®</button>
    </div>

    <div class="debug-section">
        <h2>3. localStorage æ•°æ®</h2>
        <div id="localStorageData" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkLocalStorage()">åˆ·æ–° localStorage</button>
    </div>

    <div class="debug-section">
        <h2>4. å¥–åŠ±èµ„æ ¼æ£€æŸ¥</h2>
        <div id="eligibilityCheck" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkEligibility()">æ£€æŸ¥èµ„æ ¼</button>
    </div>

    <div class="debug-section">
        <h2>5. æ“ä½œæ—¥å¿—</h2>
        <div id="log" class="code"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script src="js/modules/BackendManager.js"></script>
    <script>
        let walletConnected = false;
        let walletAddress = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function connectWallet() {
            try {
                log('å°è¯•è¿æ¥é’±åŒ…...');
                
                if (typeof window.solana !== 'undefined' && window.solana.isPhantom) {
                    const response = await window.solana.connect();
                    walletAddress = response.publicKey.toString();
                    walletConnected = true;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ${walletAddress}`);
                    checkWalletStatus();
                } else {
                    log('âŒ Phantom é’±åŒ…æœªå®‰è£…');
                    document.getElementById('walletStatus').innerHTML = 
                        '<div class="status error">Phantom é’±åŒ…æœªå®‰è£…</div>';
                }
            } catch (error) {
                log(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`);
                document.getElementById('walletStatus').innerHTML = 
                    `<div class="status error">è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        function checkWalletStatus() {
            const statusDiv = document.getElementById('walletStatus');
            
            if (walletConnected && walletAddress) {
                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… é’±åŒ…å·²è¿æ¥<br>
                        åœ°å€: ${walletAddress}<br>
                        çŸ­åœ°å€: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status warning">
                        âš ï¸ é’±åŒ…æœªè¿æ¥<br>
                        è¯·ç‚¹å‡»"è¿æ¥é’±åŒ…"æŒ‰é’®
                    </div>
                `;
            }
        }

        function checkBackendConfig() {
            try {
                log('æ£€æŸ¥åå°é…ç½®...');
                
                // åˆå§‹åŒ– BackendManager
                if (!window.backendManager) {
                    window.backendManager = new BackendManager();
                    window.backendManager.init();
                }
                
                const rewardConfig = window.backendManager.getMainCountdownRewardAddress();
                const configDiv = document.getElementById('backendConfig');
                
                if (rewardConfig && rewardConfig.address && rewardConfig.isSet) {
                    configDiv.innerHTML = `
                        <div class="status success">
                            âœ… åå°å·²é…ç½®å¥–åŠ±åœ°å€<br>
                            åœ°å€: ${rewardConfig.address}<br>
                            é‡‘é¢: ${rewardConfig.amount} ç§¯åˆ†<br>
                            è®¾ç½®æ—¶é—´: ${rewardConfig.lastUpdate}<br>
                            çŸ­åœ°å€: ${rewardConfig.address.slice(0, 6)}...${rewardConfig.address.slice(-4)}
                        </div>
                    `;
                    log(`âœ… åå°é…ç½®: ${rewardConfig.address}`);
                } else {
                    configDiv.innerHTML = `
                        <div class="status warning">
                            âš ï¸ åå°æœªé…ç½®å¥–åŠ±åœ°å€<br>
                            è¯·åœ¨åå°è®¾ç½®å¥–åŠ±åœ°å€
                        </div>
                    `;
                    log('âš ï¸ åå°æœªé…ç½®å¥–åŠ±åœ°å€');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥åå°é…ç½®å¤±è´¥: ${error.message}`);
                document.getElementById('backendConfig').innerHTML = 
                    `<div class="status error">æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        function checkLocalStorage() {
            try {
                log('æ£€æŸ¥ localStorage æ•°æ®...');
                
                const rewardAddressData = localStorage.getItem('mainCountdownRewardAddress');
                const mainCountdownRewards = localStorage.getItem('mainCountdownRewards');
                
                const storageDiv = document.getElementById('localStorageData');
                let html = '<div class="status info">';
                
                if (rewardAddressData) {
                    const data = JSON.parse(rewardAddressData);
                    html += `
                        âœ… mainCountdownRewardAddress å­˜åœ¨<br>
                        åœ°å€: ${data.address}<br>
                        é‡‘é¢: ${data.amount} ç§¯åˆ†<br>
                        å·²è®¾ç½®: ${data.isSet}<br>
                        çŸ­åœ°å€: ${data.address.slice(0, 6)}...${data.address.slice(-4)}<br><br>
                    `;
                    log(`âœ… localStorage å¥–åŠ±åœ°å€: ${data.address}`);
                } else {
                    html += 'âŒ mainCountdownRewardAddress ä¸å­˜åœ¨<br><br>';
                    log('âŒ localStorage ä¸­æ— å¥–åŠ±åœ°å€æ•°æ®');
                }
                
                if (mainCountdownRewards) {
                    const rewards = JSON.parse(mainCountdownRewards);
                    html += `âœ… mainCountdownRewards å­˜åœ¨ (${rewards.length} æ¡è®°å½•)<br>`;
                    rewards.forEach((reward, index) => {
                        html += `
                            è®°å½• ${index + 1}: ${reward.winner} - ${reward.amount} ç§¯åˆ† - ${reward.claimed ? 'å·²é¢†å–' : 'æœªé¢†å–'}<br>
                        `;
                    });
                    log(`âœ… localStorage å¥–åŠ±è®°å½•: ${rewards.length} æ¡`);
                } else {
                    html += 'âŒ mainCountdownRewards ä¸å­˜åœ¨';
                    log('âŒ localStorage ä¸­æ— å¥–åŠ±è®°å½•');
                }
                
                html += '</div>';
                storageDiv.innerHTML = html;
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥ localStorage å¤±è´¥: ${error.message}`);
                document.getElementById('localStorageData').innerHTML = 
                    `<div class="status error">æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        function checkEligibility() {
            try {
                log('æ£€æŸ¥å¥–åŠ±èµ„æ ¼...');
                
                if (!walletConnected || !walletAddress) {
                    document.getElementById('eligibilityCheck').innerHTML = 
                        '<div class="status warning">âš ï¸ è¯·å…ˆè¿æ¥é’±åŒ…</div>';
                    log('âš ï¸ é’±åŒ…æœªè¿æ¥ï¼Œæ— æ³•æ£€æŸ¥èµ„æ ¼');
                    return;
                }
                
                const rewardAddressData = localStorage.getItem('mainCountdownRewardAddress');
                if (!rewardAddressData) {
                    document.getElementById('eligibilityCheck').innerHTML = 
                        '<div class="status warning">âš ï¸ åå°æœªé…ç½®å¥–åŠ±åœ°å€</div>';
                    log('âš ï¸ åå°æœªé…ç½®å¥–åŠ±åœ°å€');
                    return;
                }
                
                const rewardConfig = JSON.parse(rewardAddressData);
                const eligibilityDiv = document.getElementById('eligibilityCheck');
                
                if (rewardConfig.address === walletAddress && rewardConfig.isSet) {
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¥–åŠ±è®°å½•
                    const mainCountdownRewards = JSON.parse(localStorage.getItem('mainCountdownRewards') || '[]');
                    const existingReward = mainCountdownRewards.find(reward => 
                        reward.winner === walletAddress && 
                        reward.evidence && 
                        reward.evidence.eligibilityCriteria === 'admin_configured_address'
                    );
                    
                    if (existingReward) {
                        if (!existingReward.claimed) {
                            eligibilityDiv.innerHTML = `
                                <div class="status success">
                                    âœ… ç¬¦åˆé¢†å–æ¡ä»¶<br>
                                    å¥–åŠ±é‡‘é¢: ${existingReward.amount} ç§¯åˆ†<br>
                                    çŠ¶æ€: æœªé¢†å–<br>
                                    å¯ä»¥é¢†å–å¥–åŠ±ï¼
                                </div>
                            `;
                            log('âœ… ç¬¦åˆé¢†å–æ¡ä»¶ï¼Œå¯ä»¥é¢†å–å¥–åŠ±');
                        } else {
                            eligibilityDiv.innerHTML = `
                                <div class="status warning">
                                    âš ï¸ å¥–åŠ±å·²é¢†å–<br>
                                    å¥–åŠ±é‡‘é¢: ${existingReward.amount} ç§¯åˆ†<br>
                                    é¢†å–æ—¶é—´: ${existingReward.claimedAt}
                                </div>
                            `;
                            log('âš ï¸ å¥–åŠ±å·²é¢†å–');
                        }
                    } else {
                        eligibilityDiv.innerHTML = `
                            <div class="status warning">
                                âš ï¸ åœ°å€åŒ¹é…ä½†æ— å¥–åŠ±è®°å½•<br>
                                å¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢æˆ–é‡æ–°æ£€æŸ¥
                            </div>
                        `;
                        log('âš ï¸ åœ°å€åŒ¹é…ä½†æ— å¥–åŠ±è®°å½•');
                    }
                } else {
                    eligibilityDiv.innerHTML = `
                        <div class="status error">
                            âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶<br>
                            å½“å‰é’±åŒ…åœ°å€: ${walletAddress}<br>
                            é…ç½®çš„å¥–åŠ±åœ°å€: ${rewardConfig.address}<br>
                            åœ°å€ä¸åŒ¹é…
                        </div>
                    `;
                    log(`âŒ åœ°å€ä¸åŒ¹é…: å½“å‰=${walletAddress}, é…ç½®=${rewardConfig.address}`);
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥èµ„æ ¼å¤±è´¥: ${error.message}`);
                document.getElementById('eligibilityCheck').innerHTML = 
                    `<div class="status error">æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            checkWalletStatus();
            checkBackendConfig();
            checkLocalStorage();
            setTimeout(() => {
                if (walletConnected) {
                    checkEligibility();
                }
            }, 1000);
        };
    </script>
</body>
</html> 